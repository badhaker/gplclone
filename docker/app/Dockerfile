# Build stage

FROM maven:3.8.1 AS build

WORKDIR /home/app

COPY src /home/app/src

COPY src/main/resources/application*.properties /home/app/src/main/resources/

ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_NAME
ARG DATABASE_USERNAME
ARG DATABASE_SCHEMA
ARG DATABASE_PASSWORD
ARG JWT_SECRET_KEY
ARG REDIS_HOST
ARG REDIS_PASSWORD
ARG REDIS_PORT
ARG ONBOARDING_URL
ARG SMTP_HOST
ARG SMTP_PASSWORD
ARG SMTP_PORT
ARG SMTP_USERNAME
ARG SMTP_FROM_EMAIL
ARG SSO_TENANT_ID
ARG SSO_ASSERTION_SERVICE_URL
ARG SSO_ISSUER
ARG SAML_CERTIFICATE
ARG SSO_REDIRECT_URL

#Store it in a env variable

ENV PROFILE=$ACTIVE_PROFILE
ENV DATABASE_HOST=$DATABASE_HOST
ENV DATABASE_PORT=$DATABASE_PORT
ENV DATABASE_NAME=$DATABASE_NAME
ENV DATABASE_USERNAME=$DATABASE_USERNAME
ENV DATABASE_SCHEMA=$DATABASE_SCHEMA
ENV DATABASE_PASSWORD=$DATABASE_PASSWORD
ENV JWT_SECRET_KEY=$JWT_SECRET_KEY
ENV REDIS_HOST=$REDIS_HOST
ENV REDIS_PASSWORD=$REDIS_PASSWORD
ENV REDIS_PORT=$REDIS_PORT
ENV ONBOARDING_URL=$ONBOARDING_URL
ENV SMTP_HOST=$SMTP_HOST
ENV SMTP_PASSWORD=$SMTP_PASSWORD
ENV SMTP_PORT=$SMTP_PORT
ENV SMTP_USERNAME=$SMTP_USERNAME
ENV SMTP_FROM_EMAIL=$SMTP_FROM_EMAIL
ENV SSO_TENANT_ID=$SSO_TENANT_ID
ENV SSO_ASSERTION_SERVICE_URL=$SSO_ASSERTION_SERVICE_URL
ENV SSO_ISSUER=$SSO_ISSUER
ENV SAML_CERTIFICATE=$SAML_CERTIFICATE
ENV SSO_REDIRECT_URL=$SSO_REDIRECT_URL

COPY pom.xml /home/app

RUN mvn -f /home/app/pom.xml clean package -DskipTests

# Package stage
FROM adoptopenjdk/openjdk11:alpine-jre

# For following variable refer the pom.xml file 'name' tag
ARG JAR_FILE=/home/app/target/ALCHEMY-0.0.1-SNAPSHOT.jar

#Get argument variable from docker-compose file
ARG ACTIVE_PROFILE
ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_NAME
ARG DATABASE_USERNAME
ARG DATABASE_SCHEMA
ARG DATABASE_PASSWORD
ARG JWT_SECRET_KEY
ARG REDIS_HOST
ARG REDIS_PASSWORD
ARG REDIS_PORT
ARG ONBOARDING_URL
ARG SMTP_HOST
ARG SMTP_PASSWORD
ARG SMTP_PORT
ARG SMTP_USERNAME
ARG SMTP_FROM_EMAIL
ARG SSO_TENANT_ID
ARG SSO_ASSERTION_SERVICE_URL
ARG SSO_ISSUER
ARG SAML_CERTIFICATE
ARG SSO_REDIRECT_URL

#Store it in a env variable
ENV PROFILE=$ACTIVE_PROFILE
ENV DATABASE_HOST=$DATABASE_HOST
ENV DATABASE_PORT=$DATABASE_PORT
ENV DATABASE_NAME=$DATABASE_NAME
ENV DATABASE_USERNAME=$DATABASE_USERNAME
ENV DATABASE_SCHEMA=$DATABASE_SCHEMA
ENV DATABASE_PASSWORD=$DATABASE_PASSWORD
ENV JWT_SECRET_KEY=$JWT_SECRET_KEY
ENV REDIS_HOST=$REDIS_HOST
ENV REDIS_PASSWORD=$REDIS_PASSWORD
ENV REDIS_PORT=$REDIS_PORT
ENV ONBOARDING_URL=$ONBOARDING_URL
ENV SMTP_HOST=$SMTP_HOST
ENV SMTP_PASSWORD=$SMTP_PASSWORD
ENV SMTP_PORT=$SMTP_PORT
ENV SMTP_USERNAME=$SMTP_USERNAME
ENV SMTP_FROM_EMAIL=$SMTP_FROM_EMAIL
ENV SSO_TENANT_ID=$SSO_TENANT_ID
ENV SSO_ASSERTION_SERVICE_URL=$SSO_ASSERTION_SERVICE_URL
ENV SSO_ISSUER=$SSO_ISSUER
ENV SAML_CERTIFICATE=$SAML_CERTIFICATE
ENV SSO_REDIRECT_URL=$SSO_REDIRECT_URL

WORKDIR /opt/app

COPY --from=build /home/app/src/main/resources/application*.properties /opt/app/src/main/resources/

COPY --from=build ${JAR_FILE} app.jar

CMD java -jar app.jar
